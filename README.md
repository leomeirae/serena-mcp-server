# Servidor MCP para API de Parcerias Serena

## üìã Vis√£o Geral

Este √© um servidor MCP (Model Context Protocol) que permite que assistentes de IA interajam com a API de Parcerias da Serena atrav√©s de ferramentas estruturadas. O servidor est√° dispon√≠vel no endpoint: **http://mwc8k8wk0wg8o8s4k0w8scc4.157.180.32.249.sslip.io/**

### üéØ Objetivo
Fornecer uma interface padronizada para que agentes de IA possam:
- Consultar √°reas de opera√ß√£o para Gera√ß√£o Distribu√≠da (GD)
- Gerenciar leads de vendas
- Validar qualifica√ß√£o de clientes
- Criar contratos de energia solar
- Interagir com a API de Parcerias da Serena de forma estruturada

## üõ†Ô∏è Ferramentas Dispon√≠veis

### üìç Gera√ß√£o Distribu√≠da (Distributed Generation)

#### 1. `consultar_areas_operacao_gd`
**Descri√ß√£o**: Consulta √°reas onde o servi√ßo de Gera√ß√£o Distribu√≠da est√° dispon√≠vel

**Par√¢metros**:
- `cidade` (string, opcional): Nome da cidade
- `estado` (string, opcional): Sigla do estado (ex: SP, RJ)
- `codigo_ibge` (string, opcional): C√≥digo IBGE da localidade

**Retorno**: Lista de √°reas de opera√ß√£o dispon√≠veis com informa√ß√µes de cobertura

**Exemplo de uso**:
```python
# Por cidade e estado
resultado = await consultar_areas_operacao_gd(
    cidade="S√£o Paulo", 
    estado="SP"
)

# Por c√≥digo IBGE
resultado = await consultar_areas_operacao_gd(
    codigo_ibge="3550308"
)
```

#### 2. `obter_planos_gd`
**Descri√ß√£o**: Obt√©m planos de Gera√ß√£o Distribu√≠da dispon√≠veis para uma localidade

**Par√¢metros**:
- `cidade` (string, obrigat√≥rio): Nome da cidade
- `estado` (string, obrigat√≥rio): Sigla do estado

**Retorno**: Lista de planos dispon√≠veis com detalhes de pot√™ncia, pre√ßos e condi√ß√µes

**Exemplo de uso**:
```python
resultado = await obter_planos_gd(
    cidade="S√£o Paulo",
    estado="SP"
)
```

### üíº Convers√£o de Vendas (Sales Conversion)

#### 3. `cadastrar_lead`
**Descri√ß√£o**: Cadastra um novo lead na base de dados

**Par√¢metros**:
- `fullName` (string, obrigat√≥rio): Nome completo
- `personType` (string, obrigat√≥rio): Tipo de pessoa ("natural" ou "legal")
- `emailAddress` (string, obrigat√≥rio): Email
- `mobilePhone` (string, obrigat√≥rio): Telefone celular
- `utilityBillingValue` (number, obrigat√≥rio): Valor da conta de energia
- `identificationNumber` (string, obrigat√≥rio): CPF/CNPJ
- `nationality` (string, obrigat√≥rio): Nacionalidade
- `maritalStatus` (string, obrigat√≥rio): Estado civil
- `profession` (string, obrigat√≥rio): Profiss√£o
- `zipCode` (string, obrigat√≥rio): CEP
- `state` (string, obrigat√≥rio): Estado
- `city` (string, obrigat√≥rio): Cidade
- `street` (string, obrigat√≥rio): Rua
- `number` (string, obrigat√≥rio): N√∫mero
- `neighborhood` (string, obrigat√≥rio): Bairro
- `complement` (string, opcional): Complemento

**Retorno**: ID do lead criado e status da opera√ß√£o

**Exemplo de uso**:
```python
dados_lead = {
    "fullName": "Jo√£o Silva",
    "personType": "natural",
    "emailAddress": "joao@email.com",
    "mobilePhone": "11999885544",
    "utilityBillingValue": 500.00,
    "identificationNumber": "12345678901",
    "nationality": "Brasileiro",
    "maritalStatus": "Solteiro",
    "profession": "Engenheiro",
    "zipCode": "01234-567",
    "state": "SP",
    "city": "S√£o Paulo",
    "street": "Rua das Flores",
    "number": "123",
    "neighborhood": "Centro",
    "complement": "Apto 45"
}

resultado = await cadastrar_lead(dados_lead)
```

#### 4. `buscar_leads`
**Descri√ß√£o**: Busca leads com filtros e pagina√ß√£o

**Par√¢metros**:
- `page` (number, opcional): N√∫mero da p√°gina (padr√£o: 1)
- `limit` (number, opcional): Limite de resultados por p√°gina (padr√£o: 10)
- `search` (string, opcional): Termo de busca
- `status` (string, opcional): Status do lead
- `personType` (string, opcional): Tipo de pessoa

**Retorno**: Lista paginada de leads com informa√ß√µes b√°sicas

**Exemplo de uso**:
```python
resultado = await buscar_leads(
    page=1,
    limit=20,
    search="Jo√£o Silva",
    status="active"
)
```

#### 5. `validar_qualificacao_lead`
**Descri√ß√£o**: Valida se um lead est√° qualificado para produtos de energia solar

**Par√¢metros**:
- `cidade` (string, obrigat√≥rio): Cidade do lead
- `estado` (string, obrigat√≥rio): Estado do lead
- `tipo_pessoa` (string, obrigat√≥rio): "natural" ou "legal"
- `valor_conta` (number, obrigat√≥rio): Valor da conta de energia

**Retorno**: Resultado da valida√ß√£o com detalhes de qualifica√ß√£o

**Exemplo de uso**:
```python
resultado = await validar_qualificacao_lead(
    cidade="S√£o Paulo",
    estado="SP",
    tipo_pessoa="natural",
    valor_conta=500.00
)
```

#### 6. `buscar_lead_por_id`
**Descri√ß√£o**: Busca informa√ß√µes detalhadas de um lead espec√≠fico

**Par√¢metros**:
- `lead_id` (string, obrigat√≥rio): ID √∫nico do lead

**Retorno**: Informa√ß√µes completas do lead incluindo hist√≥rico e status

**Exemplo de uso**:
```python
resultado = await buscar_lead_por_id("lead_123456")
```

#### 7. `atualizar_lead`
**Descri√ß√£o**: Atualiza informa√ß√µes de um lead existente

**Par√¢metros**:
- `lead_id` (string, obrigat√≥rio): ID do lead
- `dados_atualizacao` (object, obrigat√≥rio): Dados a serem atualizados

**Retorno**: Confirma√ß√£o da atualiza√ß√£o

**Exemplo de uso**:
```python
dados_atualizacao = {
    "emailAddress": "novo_email@email.com",
    "mobilePhone": "11988776655"
}

resultado = await atualizar_lead("lead_123456", dados_atualizacao)
```

#### 8. `atualizar_credenciais_distribuidora`
**Descri√ß√£o**: Atualiza credenciais de acesso √† distribuidora de energia

**Par√¢metros**:
- `lead_id` (string, obrigat√≥rio): ID do lead
- `credenciais` (object, obrigat√≥rio): Credenciais da distribuidora

**Retorno**: Confirma√ß√£o da atualiza√ß√£o das credenciais

**Exemplo de uso**:
```python
credenciais = {
    "username": "usuario_distribuidora",
    "password": "senha_distribuidora"
}

resultado = await atualizar_credenciais_distribuidora("lead_123456", credenciais)
```

#### 9. `criar_contrato`
**Descri√ß√£o**: Cria um contrato de gera√ß√£o distribu√≠da para um lead

**Par√¢metros**:
- `lead_id` (string, obrigat√≥rio): ID do lead
- `dados_contrato` (object, obrigat√≥rio): Dados do contrato

**Retorno**: ID do contrato criado e status

**Exemplo de uso**:
```python
dados_contrato = {
    "planId": "plan_123",
    "installationAddress": {
        "zipCode": "01234-567",
        "state": "SP",
        "city": "S√£o Paulo",
        "street": "Rua das Flores",
        "number": "123",
        "neighborhood": "Centro"
    }
}

resultado = await criar_contrato("lead_123456", dados_contrato)
```

## üîß Configura√ß√£o para Agentes de IA

### Configura√ß√£o MCP

Para configurar este servidor MCP em um agente de IA, adicione a seguinte configura√ß√£o:

```json
{
  "mcpServers": {
    "serena-partnerships": {
      "command": "python",
      "args": ["servidor_parcerias_mcp.py"],
      "env": {
        "PARTNERSHIP_API_KEY": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQzNDBmZWEyLWM3ZTQtNGY1Ni1hYjdlLTAyMmE5ZDcwNTBiNiIsInBhcnRuZXJUeXBlIjoicGFydG5lcl9ncm91cCIsImlhdCI6MTc0NDgzNzEzOX0.YvvCD-I4GOSPmRduMoXit8Rw05c9ILoiCjhnPMgygO0",
        "PARTNERSHIP_API_ENDPOINT": "https://partnership-service-staging.api.srna.co/"
      }
    }
  }
}
```

### Configura√ß√£o para Claude Desktop

1. Abra as configura√ß√µes do Claude Desktop
2. V√° para a se√ß√£o "MCP Servers"
3. Adicione um novo servidor com as seguintes configura√ß√µes:
   - **Nome**: Serena Partnerships API
   - **Comando**: `python`
   - **Argumentos**: `servidor_parcerias_mcp.py`
   - **Diret√≥rio de trabalho**: Caminho para este projeto
   - **Vari√°veis de ambiente**: Configure as vari√°veis PARTNERSHIP_API_KEY e PARTNERSHIP_API_ENDPOINT

### Configura√ß√£o para Ollama

Adicione ao arquivo de configura√ß√£o do Ollama:

```yaml
mcp_servers:
  - name: serena-partnerships
    command: python
    args: [servidor_parcerias_mcp.py]
    env:
      PARTNERSHIP_API_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQzNDBmZWEyLWM3ZTQtNGY1Ni1hYjdlLTAyMmE5ZDcwNTBiNiIsInBhcnRuZXJUeXBlIjoicGFydG5lcl9ncm91cCIsImlhdCI6MTc0NDgzNzEzOX0.YvvCD-I4GOSPmRduMoXit8Rw05c9ILoiCjhnPMgygO0"
      PARTNERSHIP_API_ENDPOINT: "https://partnership-service-staging.api.srna.co/"
```

## üåê Endpoints da API

### Base URL
- **Staging**: `https://partnership-service-staging.api.srna.co/`
- **Produ√ß√£o**: `https://partnership-service.api.srna.co/`

### Mapeamento de Endpoints

| Ferramenta MCP | M√©todo HTTP | Endpoint | Descri√ß√£o |
|----------------|-------------|----------|-----------|
| `consultar_areas_operacao_gd` | GET | `/distribuited-generation/operation-areas` | Consulta √°reas de opera√ß√£o |
| `obter_planos_gd` | GET | `/distribuited-generation/plans` | Obt√©m planos dispon√≠veis |
| `cadastrar_lead` | POST | `/sales-conversion/leads` | Cadastra novo lead |
| `buscar_leads` | GET | `/sales-conversion/leads` | Lista leads com filtros |
| `validar_qualificacao_lead` | GET | `/sales-conversion/leads/qualification` | Valida qualifica√ß√£o |
| `buscar_lead_por_id` | GET | `/sales-conversion/leads/{id}` | Busca lead espec√≠fico |
| `atualizar_lead` | PUT | `/sales-conversion/leads/{id}` | Atualiza lead |
| `atualizar_credenciais_distribuidora` | PATCH | `/sales-conversion/leads/{id}/energy-utility-credentials` | Atualiza credenciais |
| `criar_contrato` | POST | `/sales-conversion/leads/{id}/contracts` | Cria contrato |

## üîê Autentica√ß√£o

Todas as requisi√ß√µes utilizam autentica√ß√£o Bearer Token:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## üìä Estrutura de Dados

### Lead (Pessoa F√≠sica)
```json
{
  "fullName": "string",
  "personType": "natural",
  "emailAddress": "string",
  "mobilePhone": "string",
  "utilityBillingValue": "number",
  "identificationNumber": "string",
  "nationality": "string",
  "maritalStatus": "string",
  "profession": "string",
  "zipCode": "string",
  "state": "string",
  "city": "string",
  "street": "string",
  "number": "string",
  "neighborhood": "string",
  "complement": "string"
}
```

### Lead (Pessoa Jur√≠dica)
```json
{
  "fullName": "string",
  "personType": "legal",
  "emailAddress": "string",
  "mobilePhone": "string",
  "utilityBillingValue": "number",
  "identificationNumber": "string",
  "companyName": "string",
  "tradeName": "string",
  "zipCode": "string",
  "state": "string",
  "city": "string",
  "street": "string",
  "number": "string",
  "neighborhood": "string",
  "complement": "string"
}
```

## üöÄ Casos de Uso

### 1. Processo de Vendas Completo
```python
# 1. Verificar se a √°rea tem cobertura
areas = await consultar_areas_operacao_gd(cidade="S√£o Paulo", estado="SP")

# 2. Obter planos dispon√≠veis
planos = await obter_planos_gd(cidade="S√£o Paulo", estado="SP")

# 3. Cadastrar lead
lead_id = await cadastrar_lead(dados_cliente)

# 4. Validar qualifica√ß√£o
qualificacao = await validar_qualificacao_lead(
    cidade="S√£o Paulo",
    estado="SP",
    tipo_pessoa="natural",
    valor_conta=500.00
)

# 5. Se qualificado, criar contrato
if qualificacao.qualificado:
    contrato = await criar_contrato(lead_id, dados_contrato)
```

### 2. Consulta de Leads Existentes
```python
# Buscar leads ativos
leads = await buscar_leads(status="active", limit=50)

# Para cada lead, buscar detalhes
for lead in leads:
    detalhes = await buscar_lead_por_id(lead.id)
    print(f"Lead: {detalhes.fullName} - Status: {detalhes.status}")
```

### 3. Atualiza√ß√£o em Lote
```python
# Buscar leads que precisam de atualiza√ß√£o
leads = await buscar_leads(status="pending_credentials")

# Atualizar credenciais
for lead in leads:
    await atualizar_credenciais_distribuidora(
        lead.id, 
        {"username": "novo_user", "password": "nova_senha"}
    )
```

## ‚ö†Ô∏è Tratamento de Erros

O servidor inclui tratamento robusto de erros:

### C√≥digos de Erro Comuns
- `400`: Dados inv√°lidos ou obrigat√≥rios ausentes
- `401`: Token de autentica√ß√£o inv√°lido
- `404`: Recurso n√£o encontrado
- `422`: Dados de valida√ß√£o inv√°lidos
- `500`: Erro interno do servidor

### Exemplo de Tratamento
```python
try:
    resultado = await cadastrar_lead(dados_lead)
    print(f"Lead criado com ID: {resultado.id}")
except Exception as e:
    print(f"Erro ao cadastrar lead: {e.message}")
    if e.status_code == 422:
        print("Dados de valida√ß√£o inv√°lidos")
```

## üîí Seguran√ßa

### Boas Pr√°ticas
- ‚úÖ A chave de API √© carregada de vari√°vel de ambiente
- ‚úÖ Todas as requisi√ß√µes incluem autentica√ß√£o Bearer Token
- ‚úÖ N√£o armazene credenciais no c√≥digo fonte
- ‚úÖ Use HTTPS para todas as comunica√ß√µes
- ‚úÖ Valide todos os dados de entrada

### Configura√ß√£o de Seguran√ßa
```bash
# Configure as vari√°veis de ambiente
export PARTNERSHIP_API_KEY="sua_chave_aqui"
export PARTNERSHIP_API_ENDPOINT="https://partnership-service-staging.api.srna.co/"
```

## üìà Monitoramento e Logs

### Logs Dispon√≠veis
- Requisi√ß√µes HTTP com timestamps
- Erros de valida√ß√£o
- Tempo de resposta das APIs
- Status de autentica√ß√£o

### Exemplo de Log
```
[2024-01-15 10:30:45] INFO: Requisi√ß√£o para /sales-conversion/leads
[2024-01-15 10:30:46] INFO: Lead criado com sucesso - ID: lead_123456
[2024-01-15 10:30:47] INFO: Tempo de resposta: 1.2s
```

## üß™ Testes

### Testando as Ferramentas
```python
# Teste b√°sico de conectividade
areas = await consultar_areas_operacao_gd(cidade="S√£o Paulo", estado="SP")
assert areas is not None
assert len(areas) > 0

# Teste de cadastro de lead
lead_data = {
    "fullName": "Teste MCP",
    "personType": "natural",
    "emailAddress": "teste@mcp.com",
    # ... outros campos obrigat√≥rios
}
lead = await cadastrar_lead(lead_data)
assert lead.id is not None
```

## üìû Suporte

### Recursos de Ajuda
- **Documenta√ß√£o da API**: Consulte `api-documentation.md`
- **Issues**: Abra issues no reposit√≥rio para bugs ou melhorias
- **Equipe de Desenvolvimento**: Entre em contato para suporte t√©cnico

### Informa√ß√µes de Contato
- **Email**: dev@serena.co
- **Slack**: #serena-partnerships-api
- **Documenta√ß√£o**: https://docs.serena.co/partnerships

## üîÑ Vers√µes e Changelog

### v1.0.0 (Atual)
- ‚úÖ Implementa√ß√£o completa das 9 ferramentas MCP
- ‚úÖ Suporte a leads pessoa f√≠sica e jur√≠dica
- ‚úÖ Valida√ß√£o de qualifica√ß√£o
- ‚úÖ Cria√ß√£o de contratos
- ‚úÖ Tratamento robusto de erros

### Pr√≥ximas Vers√µes
- üîÑ Suporte a webhooks
- üîÑ Cache de consultas frequentes
- üîÑ M√©tricas de performance
- üîÑ Suporte a m√∫ltiplos ambientes

---

**Desenvolvido pela Equipe Serena** üöÄ 